<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Patching containers in TripleO | /home/emilien</title><meta name=keywords content><meta name=description content="Read this post to learn more how to update a container in TripleO on a live system."><meta name=author content="Emilien Macchi"><link rel=canonical href=https://my1.fr/blog/patching-containers-in-tripleo/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://my1.fr/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://my1.fr/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://my1.fr/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://my1.fr/favicons/apple-touch-icon.png><link rel=mask-icon href=https://my1.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Patching containers in TripleO"><meta property="og:description" content="Read this post to learn more how to update a container in TripleO on a live system."><meta property="og:type" content="article"><meta property="og:url" content="https://my1.fr/blog/patching-containers-in-tripleo/"><meta property="og:image" content="https://my1.fr/images/surgery-tools.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-02-15T00:00:00+00:00"><meta property="og:site_name" content="/home/emilien"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://my1.fr/images/surgery-tools.jpg"><meta name=twitter:title content="Patching containers in TripleO"><meta name=twitter:description content="Read this post to learn more how to update a container in TripleO on a live system."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://my1.fr/posts/"},{"@type":"ListItem","position":3,"name":"Patching containers in TripleO","item":"https://my1.fr/blog/patching-containers-in-tripleo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Patching containers in TripleO","name":"Patching containers in TripleO","description":"Read this post to learn more how to update a container in TripleO on a live system.\n","keywords":[],"articleBody":"Read this post to learn more how to update a container in TripleO on a live system.\nNote: this might sound surgery but this is I think the clean options to patch container images in TripleO.\nYour TripleO cloud is running and you want to update an rpm in one or multiple containers?\nTripleO provides some CLI to build new container images with the rpms that you want. This procedure is also documented here.\nIn this particular example, we will update the python3-networking-ovn rpm on octavia_api.\nYou need a host to build the image: The easiest place is the Undercloud or the Standalone node, where Buildah and tripleoclient are installed. We’ll build the image from that host.\nPut your rpms in a directory: e.g. in /tmp/rpms\nExport the OpenStack admin credentials: e.g.: export OS_CLOUD=standalone Login to the registry (when using OSP): podman login registry.redhat.io Build the new container image for octavia_api: openstack tripleo container image hotfix \\ --image registry.redhat.io/rhosp-rhel8/openstack-octavia-api:16.2 \\ --rpms-path /tmp/hotfix \\ --tag 16.2-customfix \\ You should see the new image by running buildah images.\nNow you’ll need to push the image to a registry (yours, or TripleO registry): e.g. :\nbuildah push registry.redhat.io/rhosp-rhel8/openstack-octavia-api:16.2-16.2-customfix docker://quay.io/emilien/openstack-octavia-api:16.2-customfix Now, there are two methods for deploying that new image.\nRun the deploy command again, after updating the ContainerOctaviaApiImage parameter in TripleO environment Run the following steps: You need to figure out what’s the TripleO step where Octavia is deployed (it’s step 4), by looking on the host in /var/lib/tripleo-config/container-startup-config and grep for octavia_api.\nNow, go on the host where you want to use that new image (in the case of Standalone, it’s the same host where you built the image) and create an Ansible playbook with this content (e.g. paunch.yaml):\n- hosts: localhost become: true vars: service_name: octavia_api tasks: - name: Stop and clean the old container command: systemctl stop {{ service name }} \u0026\u0026 podman rm {{ service_name }} - name: Start containers for step 1 paunch: config: /var/lib/tripleo-config/container-startup-config/step_4/hashed-{{ service_name }}.json config_overrides: octavia_api: image: quay.io/emilien/openstack-octavia-api:16.2-customfix\" config_id: tripleo_step4 cleanup: false action: apply Change the content for your needs (different step, image, etc).\nRun Ansible with:\nansible-playbook paunch.yaml Your container is now running with your custom image (check with podman inspect).\nFor more details or help, check out the TripleO manuals or ask for help on IRC #tripleo (OFTC now).\n","wordCount":"386","inLanguage":"en","image":"https://my1.fr/images/surgery-tools.jpg","datePublished":"2022-02-15T00:00:00Z","dateModified":"2022-02-15T00:00:00Z","author":{"@type":"Person","name":"Emilien Macchi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://my1.fr/blog/patching-containers-in-tripleo/"},"publisher":{"@type":"Organization","name":"/home/emilien","logo":{"@type":"ImageObject","url":"https://my1.fr/favicons/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://my1.fr accesskey=h title="Emilien Macchi (Alt + H)"><img src=https://my1.fr/images/em.png alt=logo aria-label=logo height=35>Emilien Macchi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://my1.fr/categories/ title=categories><span>categories</span></a></li><li><a href=https://my1.fr/search title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://my1.fr/about-me title="about me"><span>about me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://my1.fr>Home</a>&nbsp;»&nbsp;<a href=https://my1.fr/posts/>Posts</a></div><h1 class=post-title>Patching containers in TripleO</h1><div class=post-meta><span title='2022-02-15 00:00:00 +0000 UTC'>February 15, 2022</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;386 words&nbsp;·&nbsp;Emilien Macchi&nbsp;|&nbsp;<a href=https://github.com/EmilienM/website_source/content/posts/patching-containers-in-tripleo.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><figure class=entry-cover><img loading=lazy src=https://my1.fr/images/surgery-tools.jpg alt></figure><div class=post-content><p>Read this post to learn more how to update a container in TripleO on a live system.</p><p><strong>Note: this might sound <em>surgery</em> but this is I think the clean options to patch container images in TripleO.</strong></p><p>Your TripleO cloud is running and you want to update an rpm in one or multiple containers?</p><p>TripleO provides some CLI to build new container images with the rpms that you want. This procedure is also documented <a href=https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/deployment/container_image_prepare.html#building-hotfixed-containers>here</a>.</p><p>In this particular example, we will update the <strong>python3-networking-ovn</strong> rpm on <strong>octavia_api</strong>.</p><ol><li>You need a host to build the image:</li></ol><p>The easiest place is the Undercloud or the Standalone node, where Buildah and tripleoclient are installed. We&rsquo;ll build the image from that host.</p><ol start=2><li>Put your rpms in a directory:</li></ol><p>e.g. in <strong>/tmp/rpms</strong></p><ol start=3><li>Export the OpenStack admin credentials: e.g.:</li></ol><pre tabindex=0><code>export OS_CLOUD=standalone
</code></pre><ol start=4><li>Login to the registry (when using OSP):</li></ol><pre tabindex=0><code>podman login registry.redhat.io
</code></pre><ol start=5><li>Build the new container image for octavia_api:</li></ol><pre tabindex=0><code>openstack tripleo container image hotfix \
    --image registry.redhat.io/rhosp-rhel8/openstack-octavia-api:16.2 \
    --rpms-path /tmp/hotfix \
    --tag 16.2-customfix \
</code></pre><p>You should see the new image by running <strong>buildah images</strong>.</p><p>Now you&rsquo;ll need to push the image to a registry (yours, or TripleO registry): e.g. :</p><pre tabindex=0><code>buildah push registry.redhat.io/rhosp-rhel8/openstack-octavia-api:16.2-16.2-customfix docker://quay.io/emilien/openstack-octavia-api:16.2-customfix
</code></pre><p>Now, there are two methods for deploying that new image.</p><ul><li>Run the deploy command again, after updating the <strong>ContainerOctaviaApiImage</strong> parameter in TripleO environment</li><li>Run the following steps:</li></ul><p>You need to figure out what&rsquo;s the TripleO step where Octavia is deployed (it&rsquo;s step 4), by looking on the host in <strong>/var/lib/tripleo-config/container-startup-config</strong> and grep for <strong>octavia_api</strong>.</p><p>Now, go on the host where you want to use that new image (in the case of Standalone, it&rsquo;s the same host where you built the image) and create an Ansible playbook with this content (e.g. paunch.yaml):</p><pre tabindex=0><code>- hosts: localhost
  become: true
  vars:
    service_name: octavia_api
  tasks:
  - name: Stop and clean the old container
    command: systemctl stop {{ service name }} &amp;&amp; podman rm {{ service_name }}
  - name: Start containers for step 1
    paunch:
      config: /var/lib/tripleo-config/container-startup-config/step_4/hashed-{{ service_name }}.json
      config_overrides:
        octavia_api:
          image: quay.io/emilien/openstack-octavia-api:16.2-customfix&#34;
      config_id: tripleo_step4
      cleanup: false
      action: apply
</code></pre><p>Change the content for your needs (different step, image, etc).</p><p>Run Ansible with:</p><pre tabindex=0><code>ansible-playbook paunch.yaml
</code></pre><p>Your container is now running with your custom image (check with <strong>podman inspect</strong>).</p><p>For more details or help, check out the TripleO manuals or ask for help on IRC #tripleo (OFTC now).</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://my1.fr/blog/moving-container-images-from-docker-io-to-quay-io/><span class=title>« Prev</span><br><span>Moving container images from docker.io to quay.io</span></a>
<a class=next href=https://my1.fr/blog/what-leadership-means-to-me/><span class=title>Next »</span><br><span>What Leadership Means To Me</span></a></nav></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>