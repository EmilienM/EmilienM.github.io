<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains | /home/emilien</title>
<meta name=keywords content><meta name=description content="This is my second post of a series which will cover how you can distribute your OpenShift cluster across multiple datacenter domains and increase
availability and performance of your control plane."><meta name=author content="Emilien Macchi"><link rel=canonical href=https://my1.fr/blog/openshift-external-load-balancer-control-plane-with-failure-domains/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3d6795b2f1ac0e4bd04f5bc3451ad5b7e0f4c3a914e6e8d8e980d49d9a989862.css integrity="sha256-PWeVsvGsDkvQT1vDRRrVt+D0w6kU5ujY6YDUnZqYmGI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://my1.fr/favicons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://my1.fr/favicons/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://my1.fr/favicons/favicon-32x32.png><link rel=apple-touch-icon href=https://my1.fr/favicons/apple-touch-icon.png><link rel=mask-icon href=https://my1.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains"><meta property="og:description" content="This is my second post of a series which will cover how you can distribute your OpenShift cluster across multiple datacenter domains and increase
availability and performance of your control plane."><meta property="og:type" content="article"><meta property="og:url" content="https://my1.fr/blog/openshift-external-load-balancer-control-plane-with-failure-domains/"><meta property="og:image" content="https://my1.fr/images/example-lb.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-17T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-17T00:00:00+00:00"><meta property="og:site_name" content="/home/emilien"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://my1.fr/images/example-lb.png"><meta name=twitter:title content="Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains"><meta name=twitter:description content="This is my second post of a series which will cover how you can distribute your OpenShift cluster across multiple datacenter domains and increase
availability and performance of your control plane."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://my1.fr/posts/"},{"@type":"ListItem","position":3,"name":"Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains","item":"https://my1.fr/blog/openshift-external-load-balancer-control-plane-with-failure-domains/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains","name":"Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains","description":"This is my second post of a series which will cover how you can distribute your OpenShift cluster across multiple datacenter domains and increase availability and performance of your control plane.\n","keywords":[],"articleBody":"This is my second post of a series which will cover how you can distribute your OpenShift cluster across multiple datacenter domains and increase availability and performance of your control plane.\nBackground If you haven’t read it, please have a look at the first post.\nFailure Domains Failure Domains help to spread the OpenShift control plane across multiple (at least 3) domains where each domain has a defined storage / network / compute configuration. In a modern datacenter, each domain has its own power unit, network and storage fabric, etc. If a domain goes down, it wouldn’t have an impact on the workloads since the other domains are healthy and the services are deployed in HA.\nIn this context, we think that the SLA of OpenShift can significantly be increased by deploying the OpenShift cluster (control plane and workloads) across at least 3 domains.\nIn OCP 4.13, Failure Domains will be TechPreview (not supported) but you can still test it. We plan to make it supported in a future release.\nIf you remember the previous post, we were deploying OpenShift within one domain, with one external load balancer. Now that we have Failure Domains, let’s deploy 3 external LBs (one in each domain) and then a cluster that is distributed over 3 domains.\nPre-requisites At least 3 networks and subnets (can be tenant or provider networks) have to be pre-created. They need to be reachable from where Ansible will be run. The machines used for the LB have to be deployed on CentOS9 (this is what we test).\nDeploy your own Load-Balancers In our example, we’ll deploy one LB per leaf, which is in its own routed network. Therefore, we’ll deploy 3 load balancers.\nLet’s deploy!\nCreate your Ansible inventory.yaml file:\n--- all: hosts: lb1: ansible_host: 192.168.11.2 config: lb1 lb2 ansible_host: 192.168.12.2 config: lb2 lb3: ansible_host: 192.168.13.2 config: lb3 vars: ansible_user: cloud-user ansible_become: true Create the Ansible playbook.yaml file:\n--- - hosts: - lb1 - lb2 - lb3 tasks: - name: Deploy the LBs include_role: name: emilienm.routed_lb Write the LB configs in Ansible vars.yaml:\n--- configs: lb1: bgp_asn: 64998 bgp_neighbors: - ip: 192.168.11.1 password: f00barZ services: \u0026services - name: api vips: - 192.168.100.240 min_backends: 1 healthcheck: \"httpchk GET /readyz HTTP/1.0\" balance: roundrobin frontend_port: 6443 haproxy_monitor_port: 8081 backend_opts: \"check check-ssl inter 1s fall 2 rise 3 verify none\" backend_port: 6443 backend_hosts: \u0026lb_hosts - name: rack1-10 ip: 192.168.11.10 - name: rack1-11 ip: 192.168.11.11 - name: rack1-12 ip: 192.168.11.12 - name: rack1-13 ip: 192.168.11.13 - name: rack1-14 ip: 192.168.11.14 - name: rack1-15 ip: 192.168.11.15 - name: rack1-16 ip: 192.168.11.16 - name: rack1-17 ip: 192.168.11.17 - name: rack1-18 ip: 192.168.11.18 - name: rack1-19 ip: 192.168.11.19 - name: rack1-20 ip: 192.168.11.20 - name: rack2-10 ip: 192.168.12.10 - name: rack2-11 ip: 192.168.12.11 - name: rack2-12 ip: 192.168.12.12 - name: rack2-13 ip: 192.168.12.13 - name: rack2-14 ip: 192.168.12.14 - name: rack2-15 ip: 192.168.12.15 - name: rack2-16 ip: 192.168.12.16 - name: rack2-17 ip: 192.168.12.17 - name: rack2-18 ip: 192.168.12.18 - name: rack2-19 ip: 192.168.12.19 - name: rack2-20 ip: 192.168.12.20 - name: rack3-10 ip: 192.168.13.10 - name: rack3-11 ip: 192.168.13.11 - name: rack3-12 ip: 192.168.13.12 - name: rack3-13 ip: 192.168.13.13 - name: rack3-14 ip: 192.168.13.14 - name: rack3-15 ip: 192.168.13.15 - name: rack3-16 ip: 192.168.13.16 - name: rack3-17 ip: 192.168.13.17 - name: rack3-18 ip: 192.168.13.18 - name: rack3-19 ip: 192.168.13.19 - name: rack3-20 ip: 192.168.13.20 - name: ingress_http vips: - 192.168.100.250 min_backends: 1 healthcheck: \"httpchk GET /healthz/ready HTTP/1.0\" frontend_port: 80 haproxy_monitor_port: 8082 balance: roundrobin backend_opts: \"check check-ssl port 1936 inter 1s fall 2 rise 3 verify none\" backend_port: 80 backend_hosts: *lb_hosts - name: ingress_https vips: - 192.168.100.250 min_backends: 1 healthcheck: \"httpchk GET /healthz/ready HTTP/1.0\" frontend_port: 443 haproxy_monitor_port: 8083 balance: roundrobin backend_opts: \"check check-ssl port 1936 inter 1s fall 2 rise 3 verify none\" backend_port: 443 backend_hosts: *lb_hosts - name: mcs vips: - 192.168.100.240 min_backends: 1 frontend_port: 22623 haproxy_monitor_port: 8084 balance: roundrobin backend_opts: \"check check-ssl inter 5s fall 2 rise 3 verify none\" backend_port: 22623 backend_hosts: *lb_hosts lb2: bgp_asn: 64998 bgp_neighbors: - ip: 192.168.12.1 password: f00barZ services: \u0026services lb3: bgp_asn: 64998 bgp_neighbors: - ip: 192.168.13.1 password: f00barZ services: \u0026services In this case, we deploy OpenShift on OpenStack which doesn’t support static IPs. Therefore, we have to put all the available IPs from the subnets used for the machines, in the HAproxy backends.\nInstall the role and the dependencies:\nansible-galaxy install emilienm.routed_lb,1.0.0 ansible-galaxy collection install ansible.posix ansible.utils Deploy the LBs:\nansible-playbook -i inventory.yaml -e \"@vars.yaml\" playbook.yaml Deploy OpenShift Here is an example of install-config.yaml:\napiVersion: v1 baseDomain: mydomain.test compute: - name: worker platform: openstack: type: m1.xlarge replicas: 1 controlPlane: name: master platform: openstack: type: m1.xlarge failureDomains: - portTargets: - id: control-plane network: id: fb6f8fea-5063-4053-81b3-6628125ed598 fixedIPs: - subnet: id: b02175dd-95c6-4025-8ff3-6cf6797e5f86 - portTargets: - id: control-plane network: id: 9a5452a8-41d9-474c-813f-59b6c34194b6 fixedIPs: - subnet: id: 5fe5b54a-217c-439d-b8eb-441a03f7636d - portTargets: - id: control-plane network: id: 3ed980a6-6f8e-42d3-8500-15f18998c434 fixedIPs: - subnet: id: a7d57db6-f896-475f-bdca-c3464933ec02 replicas: 3 metadata: name: mycluster networking: clusterNetwork: - cidr: 10.128.0.0/14 hostPrefix: 23 machineNetwork: - cidr: 192.168.11.0/24 - cidr: 192.168.100.0/24 platform: openstack: cloud: mycloud machinesSubnet: 8586bf1a-cc3c-4d40-bdf6-c243decc603a apiVIPs: - 192.168.100.240 ingressVIPs: - 192.168.100.250 loadBalancer: type: UserManaged featureSet: TechPreviewNoUpgrade After the deployment, you’ll only have one worker in the first domain. To deploy more workers in other domains, you’ll have to create a MachineSet per domain (the procedure is well documented in OpenShift already).\nNote that for each Failure Domain, you have to provide the leaf network ID and its subnet ID as well. If you deploy with availability zones, you’ll be able to provide them in each domain. The documentation for this feature is in progress and I’ll update this post once we have it published.\nIf you’re interested by a demo, I recorded one here.\nKnown limitations Deploying OpenShift with static IPs for the machines is not supported with OpenStack platform for now. Changing the IP address for any OpenShift control plane VIP (API + Ingress) is currently not supported. So once the external LB and the OpenShift cluster is deployed, the VIPs can’t be changed. Migrating an OpenShift cluster from the OpenShift managed LB to an external LB is currently not supported. Failure Domains are only for the control plane for now, and will be extended to the compute nodes. Keep in mind that the features will be TechPreview at first and once it has reached some maturity, we’ll promote them to GA.\nWrap-up In this article, we combined both exciting features that will help to increase your SLA and also improve the performances not only on the control plane but also for the workloads.\nWe have already got positive feedback from various teams, who tested it at a large scale and demonstrated that in this scenario, OpenShift is more reliable, better load-balanced and distributed in case of failure.\nIn a future post, I want to cover how you can make your workloads more reliable by using MetalLB as a load balancer in BGP mode.\nI hope you liked it and please provide any feedback on the channels.\n","wordCount":"1152","inLanguage":"en","image":"https://my1.fr/images/example-lb.png","datePublished":"2023-03-17T00:00:00Z","dateModified":"2023-03-17T00:00:00Z","author":{"@type":"Person","name":"Emilien Macchi"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://my1.fr/blog/openshift-external-load-balancer-control-plane-with-failure-domains/"},"publisher":{"@type":"Organization","name":"/home/emilien","logo":{"@type":"ImageObject","url":"https://my1.fr/favicons/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://my1.fr accesskey=h title="Emilien Macchi (Alt + H)"><img src=https://my1.fr/images/em.png alt aria-label=logo height=35>Emilien Macchi</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://my1.fr/categories/ title=categories><span>categories</span></a></li><li><a href=https://my1.fr/search title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://my1.fr/about-me title="about me"><span>about me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://my1.fr>Home</a>&nbsp;»&nbsp;<a href=https://my1.fr/posts/>Posts</a></div><h1 class=post-title>Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains</h1><div class=post-meta>&lt;span title='2023-03-17 00:00:00 +0000 UTC'>March 17, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;6 min&amp;nbsp;·&amp;nbsp;1152 words&amp;nbsp;·&amp;nbsp;Emilien Macchi</div></header><figure class=entry-cover><img loading=lazy src=https://my1.fr/images/example-lb.png alt></figure><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#background aria-label=Background>Background</a></li><li><a href=#failure-domains aria-label="Failure Domains">Failure Domains</a></li><li><a href=#pre-requisites aria-label=Pre-requisites>Pre-requisites</a></li><li><a href=#deploy-your-own-load-balancers aria-label="Deploy your own Load-Balancers">Deploy your own Load-Balancers</a></li><li><a href=#deploy-openshift aria-label="Deploy OpenShift">Deploy OpenShift</a></li><li><a href=#known-limitations aria-label="Known limitations">Known limitations</a></li><li><a href=#wrap-up aria-label=Wrap-up>Wrap-up</a></li></ul></div></details></div><div class=post-content><p>This is my second post of a series which will cover how you can distribute your OpenShift cluster across multiple datacenter domains and increase
availability and performance of your control plane.</p><h3 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>#</a></h3><p>If you haven&rsquo;t read it, please have a look at the <a href=https://my1.fr/blog/openshift-external-load-balancer-control-plane-intro>first post</a>.</p><h3 id=failure-domains>Failure Domains<a hidden class=anchor aria-hidden=true href=#failure-domains>#</a></h3><p>Failure Domains help to spread the OpenShift control plane across multiple (at least 3) domains where each domain has a defined storage / network / compute configuration.
In a modern datacenter, each domain has its own power unit, network and storage fabric, etc. If a domain goes down, it wouldn&rsquo;t have
an impact on the workloads since the other domains are healthy and the services are deployed in HA.</p><p>In this context, we think that the SLA of OpenShift can significantly be increased by deploying the OpenShift cluster (control plane and workloads)
across at least 3 domains.</p><p>In OCP 4.13, Failure Domains will be TechPreview (not supported) but you can still test it. We plan to make it supported in a future release.</p><p>If you remember the previous post, we were deploying OpenShift within one domain, with one external load balancer.
Now that we have Failure Domains, let&rsquo;s deploy 3 external LBs (one in each domain) and then a cluster that is distributed
over 3 domains.</p><h3 id=pre-requisites>Pre-requisites<a hidden class=anchor aria-hidden=true href=#pre-requisites>#</a></h3><p>At least 3 networks and subnets (can be tenant or provider networks) have to be pre-created.
They need to be reachable from where Ansible will be run. The machines used for the LB have to be
deployed on CentOS9 (this is what we test).</p><h3 id=deploy-your-own-load-balancers>Deploy your own Load-Balancers<a hidden class=anchor aria-hidden=true href=#deploy-your-own-load-balancers>#</a></h3><p>In our example, we&rsquo;ll deploy one LB per leaf, which is in its own routed network.
Therefore, we&rsquo;ll deploy 3 load balancers.</p><p>Let&rsquo;s deploy!</p><p>Create your Ansible <code>inventory.yaml</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>all</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lb1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=l>lb1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=l>lb2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=l>lb2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>lb3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>ansible_host</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>config</span><span class=p>:</span><span class=w> </span><span class=l>lb3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>vars</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_user</span><span class=p>:</span><span class=w> </span><span class=l>cloud-user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ansible_become</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre></div><p>Create the Ansible <code>playbook.yaml</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>lb1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>lb2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>lb3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Deploy the LBs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>include_role</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>emilienm.routed_lb</span><span class=w>
</span></span></span></code></pre></div><p>Write the LB configs in Ansible <code>vars.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lb1</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp_asn</span><span class=p>:</span><span class=w> </span><span class=m>64998</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp_neighbors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>f00barZ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>vips</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=m>192.168.100.240</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min_backends</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;httpchk GET /readyz HTTP/1.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>balance</span><span class=p>:</span><span class=w> </span><span class=l>roundrobin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>frontend_port</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>haproxy_monitor_port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_opts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;check check-ssl inter 1s fall 2 rise 3 verify none&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_port</span><span class=p>:</span><span class=w> </span><span class=m>6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_hosts</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;lb_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack1-20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack2-20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.13</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.16</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.17</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.18</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.19</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rack3-20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress_http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>vips</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=m>192.168.100.250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min_backends</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;httpchk GET /healthz/ready HTTP/1.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>frontend_port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>haproxy_monitor_port</span><span class=p>:</span><span class=w> </span><span class=m>8082</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>balance</span><span class=p>:</span><span class=w> </span><span class=l>roundrobin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_opts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;check check-ssl port 1936 inter 1s fall 2 rise 3 verify none&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_hosts</span><span class=p>:</span><span class=w> </span><span class=cp>*lb_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ingress_https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>vips</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=m>192.168.100.250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min_backends</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;httpchk GET /healthz/ready HTTP/1.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>frontend_port</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>haproxy_monitor_port</span><span class=p>:</span><span class=w> </span><span class=m>8083</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>balance</span><span class=p>:</span><span class=w> </span><span class=l>roundrobin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_opts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;check check-ssl port 1936 inter 1s fall 2 rise 3 verify none&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_port</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_hosts</span><span class=p>:</span><span class=w> </span><span class=cp>*lb_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>vips</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=m>192.168.100.240</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>min_backends</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>frontend_port</span><span class=p>:</span><span class=w> </span><span class=m>22623</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>haproxy_monitor_port</span><span class=p>:</span><span class=w> </span><span class=m>8084</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>balance</span><span class=p>:</span><span class=w> </span><span class=l>roundrobin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_opts</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;check check-ssl inter 5s fall 2 rise 3 verify none&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_port</span><span class=p>:</span><span class=w> </span><span class=m>22623</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend_hosts</span><span class=p>:</span><span class=w> </span><span class=cp>*lb_hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lb2</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp_asn</span><span class=p>:</span><span class=w> </span><span class=m>64998</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp_neighbors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.12.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>f00barZ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;services</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>lb3</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp_asn</span><span class=p>:</span><span class=w> </span><span class=m>64998</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bgp_neighbors</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.13.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>f00barZ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=cp>&amp;services</span><span class=w>
</span></span></span></code></pre></div><p>In this case, we deploy OpenShift on OpenStack which doesn&rsquo;t support static IPs. Therefore, we have to put all the available IPs from the subnets used for the machines, in the HAproxy backends.</p><p>Install the role and the dependencies:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible-galaxy install emilienm.routed_lb,1.0.0
</span></span><span class=line><span class=cl>ansible-galaxy collection install ansible.posix ansible.utils
</span></span></code></pre></div><p>Deploy the LBs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ansible-playbook -i inventory.yaml -e <span class=s2>&#34;@vars.yaml&#34;</span> playbook.yaml
</span></span></code></pre></div><h3 id=deploy-openshift>Deploy OpenShift<a hidden class=anchor aria-hidden=true href=#deploy-openshift>#</a></h3><p>Here is an example of <code>install-config.yaml</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>baseDomain</span><span class=p>:</span><span class=w> </span><span class=l>mydomain.test </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>compute</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>worker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>platform</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>openstack</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>m1.xlarge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>controlPlane</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>platform</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>openstack</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>m1.xlarge</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureDomains</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>portTargets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>fb6f8fea-5063-4053-81b3-6628125ed598</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>fixedIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>subnet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>b02175dd-95c6-4025-8ff3-6cf6797e5f86</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>portTargets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>9a5452a8-41d9-474c-813f-59b6c34194b6</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>fixedIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>subnet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>5fe5b54a-217c-439d-b8eb-441a03f7636d</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>portTargets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>control-plane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>3ed980a6-6f8e-42d3-8500-15f18998c434</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>fixedIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>subnet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=l>a7d57db6-f896-475f-bdca-c3464933ec02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mycluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>networking</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterNetwork</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>10.128.0.0</span><span class=l>/14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPrefix</span><span class=p>:</span><span class=w> </span><span class=m>23</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>machineNetwork</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>192.168.11.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>cidr</span><span class=p>:</span><span class=w> </span><span class=m>192.168.100.0</span><span class=l>/24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>platform</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>openstack</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cloud</span><span class=p>:</span><span class=w> </span><span class=l>mycloud</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>machinesSubnet</span><span class=p>:</span><span class=w> </span><span class=l>8586bf1a-cc3c-4d40-bdf6-c243decc603a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>192.168.100.240</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ingressVIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>192.168.100.250</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>UserManaged</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>featureSet</span><span class=p>:</span><span class=w> </span><span class=l>TechPreviewNoUpgrade</span><span class=w>
</span></span></span></code></pre></div><p>After the deployment, you&rsquo;ll only have one worker in the first domain. To deploy more workers in other domains, you&rsquo;ll
have to create a MachineSet per domain (the procedure is well documented in OpenShift already).</p><p>Note that for each Failure Domain, you have to provide the leaf network ID and its subnet ID as well.
If you deploy with availability zones, you&rsquo;ll be able to provide them in each domain. The documentation
for this feature is in progress and I&rsquo;ll update this post once we have it published.</p><p>If you&rsquo;re interested by a demo, I recorded one <a href=https://youtu.be/bpvoRE42eqk>here</a>.</p><h3 id=known-limitations>Known limitations<a hidden class=anchor aria-hidden=true href=#known-limitations>#</a></h3><ul><li>Deploying OpenShift with static IPs for the machines is not supported with OpenStack platform for now.</li><li>Changing the IP address for any OpenShift control plane VIP (API + Ingress) is currently not supported. So once the external LB and the OpenShift
cluster is deployed, the VIPs can&rsquo;t be changed.</li><li>Migrating an OpenShift cluster from the OpenShift managed LB to an external LB is currently not supported.</li><li>Failure Domains are only for the control plane for now, and will be extended to the compute nodes.</li></ul><p>Keep in mind that the features will be TechPreview at first and once it has reached some maturity, we&rsquo;ll promote them to GA.</p><h3 id=wrap-up>Wrap-up<a hidden class=anchor aria-hidden=true href=#wrap-up>#</a></h3><p>In this article, we combined both exciting features that will help to increase your SLA and also improve the performances
not only on the control plane but also for the workloads.</p><p>We have already got positive feedback from various teams, who tested it at a large scale and demonstrated that in this scenario, OpenShift is more reliable,
better load-balanced and distributed in case of failure.</p><p>In a future post, I want to cover how you can make your workloads more reliable by using <a href=https://metallb.universe.tf/>MetalLB</a> as a load balancer in BGP mode.</p><p>I hope you liked it and please provide any feedback on the channels.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://my1.fr/blog/developing-cluster-api-provider-openstack-with-tilt/><span class=title>« Prev</span><br><span>Developing cluster-api-provider-openstack with Tilt</span>
</a><a class=next href=https://my1.fr/blog/openshift-external-load-balancer-control-plane-intro/><span class=title>Next »</span><br><span>Deploying OpenShift with an External Load-Balancer for your control plane</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains on twitter" href="https://twitter.com/intent/tweet/?text=Deploying%20OpenShift%20on%20OpenStack%20with%20an%20External%20Load-Balancer%20for%20your%20control%20plane%20in%20multiple%20Failure%20Domains&amp;url=https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f&amp;title=Deploying%20OpenShift%20on%20OpenStack%20with%20an%20External%20Load-Balancer%20for%20your%20control%20plane%20in%20multiple%20Failure%20Domains&amp;summary=Deploying%20OpenShift%20on%20OpenStack%20with%20an%20External%20Load-Balancer%20for%20your%20control%20plane%20in%20multiple%20Failure%20Domains&amp;source=https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f&title=Deploying%20OpenShift%20on%20OpenStack%20with%20an%20External%20Load-Balancer%20for%20your%20control%20plane%20in%20multiple%20Failure%20Domains"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains on whatsapp" href="https://api.whatsapp.com/send?text=Deploying%20OpenShift%20on%20OpenStack%20with%20an%20External%20Load-Balancer%20for%20your%20control%20plane%20in%20multiple%20Failure%20Domains%20-%20https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying OpenShift on OpenStack with an External Load-Balancer for your control plane in multiple Failure Domains on telegram" href="https://telegram.me/share/url?text=Deploying%20OpenShift%20on%20OpenStack%20with%20an%20External%20Load-Balancer%20for%20your%20control%20plane%20in%20multiple%20Failure%20Domains&amp;url=https%3a%2f%2fmy1.fr%2fblog%2fopenshift-external-load-balancer-control-plane-with-failure-domains%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://emilien-blog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer class=footer><span>&copy; 2024 <a href=https://my1.fr>/home/emilien</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>