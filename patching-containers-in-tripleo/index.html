<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.100.2"><link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/dsrkafuu/dsr-cdn-main@1/images/favicons/dsrca.ico><title>Patching containers in TripleO - /home/emilien</title><meta name=author content="Emilien"><meta name=description content="Technical randomness"><meta property="og:title" content="Patching containers in TripleO"><meta name=twitter:title content="Patching containers in TripleO"><meta property="og:type" content="article"><meta property="og:url" content="https://emilienm.github.io/patching-containers-in-tripleo/"><meta property="og:description" content="Read this post to learn more how to update a container in TripleO on a live system."><meta name=twitter:description content="Read this post to learn more how to update a container in TripleO on a live system."><meta name=twitter:card content="summary"><meta property="article:published_time" content="2022-02-15T19:25:37+00:00"><meta property="article:modified_time" content="2022-06-14T14:37:49-04:00"><style>@media(prefers-color-scheme:dark){body[data-theme=auto] img{filter:brightness(60%)}}body[data-theme=dark] img{filter:brightness(60%)}</style><link rel=stylesheet href=https://emilienm.github.io/assets/css/fuji.min.css></head><body data-theme=auto data-theme-auto=false><script data-cfasync=false>var fujiThemeData=localStorage.getItem('fuji_data-theme');fujiThemeData?fujiThemeData!=='auto'&&document.body.setAttribute('data-theme',fujiThemeData==='dark'?'dark':'light'):localStorage.setItem('fuji_data-theme','auto')</script><header><div class="container-lg clearfix"><div class="col-12 header"><a class=title-main href=https://emilienm.github.io/>/home/emilien</a></div></div></header><main><div class="container-lg clearfix"><div class="col-12 col-md-9 float-left content"><div class=post><h1>Patching containers in TripleO</h1><time datetime=2022-02-15T19:25:37Z class=post-date>Published: Tue, Feb 15, 2022</time>
<time datetime=2022-02-15T19:25:37Z class=post-date>Updated: Tue, Jun 14, 2022</time><p>Read this post to learn more how to update a container in TripleO on a live system.</p><p><strong>Note: this might sound <em>surgery</em> but this is I think the clean options to patch container images in TripleO.</strong></p><p>Your TripleO cloud is running and you want to update an rpm in one or multiple containers?</p><p>TripleO provides some CLI to build new container images with the rpms that you want. This procedure is also documented <a href=https://docs.openstack.org/project-deploy-guide/tripleo-docs/latest/deployment/container_image_prepare.html#building-hotfixed-containers target=_blank>here</a>.</p><p>In this particular example, we will update the <strong>python3-networking-ovn</strong> rpm on <strong>octavia_api</strong>.</p><ol><li>You need a host to build the image. The easiest place is the Undercloud or the Standalone node, where Buildah and tripleoclient are installed. We&rsquo;ll build the image from that host.</li><li>Put your rpms in a directory, e.g. <strong>/tmp/rpms</strong></li><li>Export the OpenStack admin credentials: e.g. <strong>export OS_CLOUD=standalone</strong></li><li>Login to the registry (when using OSP): <strong>podman login registry.redhat.io</strong></li><li>Build the new container image for octavia_api:</li></ol><p> </p><p>You should see the new image by running <strong>buildah images</strong>.</p><p>Now you&rsquo;ll need to push the image to a registry (yours, or TripleO registry): e.g. <strong>buildah push registry.redhat.io/rhosp-rhel8/openstack-octavia-api:16.2-16.2-customfix docker://quay.io/emilien/openstack-octavia-api:16.2-customfix</strong></p><p>Now, there are two methods for deploying that new image.</p><ul><li>Run the deploy command again, after updating the <strong>ContainerOctaviaApiImage</strong> parameter in TripleO environment</li><li>Run the following steps:</li></ul><p>You need to figure out what&rsquo;s the TripleO step where Octavia is deployed (it&rsquo;s step 4), by looking on the host in <strong>/var/lib/tripleo-config/container-startup-config</strong> and grep for <strong>octavia_api</strong>.</p><p>Now, go on the host where you want to use that new image (in the case of Standalone, it&rsquo;s the same host where you built the image) and create an Ansible playbook with this content (e.g. paunch.yaml):</p><p>Change the content for your needs (different step, image, etc).</p><p>Run Ansible with <strong>ansible-playbook paunch.yaml</strong>.</p><p>Your container is now running with your custom image (check with <strong>podman inspect</strong>).</p><p> </p><p>For more details or help, check out the TripleO manuals or ask for help on IRC #tripleo (OFTC now).</p></div></div><aside class="col-12 col-md-3 float-left sidebar"><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div></div></div><div class="sidebar-item sidebar-toc"><h3>Table of Contents</h3><nav id=TableOfContents></nav></div></aside></div><div class=btn><div class=btn-menu id=btn-menu><i class="iconfont icon-grid-sharp"></i></div><div class=btn-toggle-mode><i class="iconfont icon-contrast-sharp"></i></div><div class=btn-scroll-top><i class="iconfont icon-chevron-up-circle-sharp"></i></div></div><aside class=sidebar-mobile style=display:none><div class=sidebar-wrapper><div class="sidebar-item sidebar-pages"><h3>Pages</h3><ul></ul></div><div class="sidebar-item sidebar-links"><h3>Links</h3><ul></ul></div><div class="sidebar-item sidebar-tags"><h3>Tags</h3><div></div></div></div></aside></main><footer><div class="container-lg clearfix"><div class="col-12 footer"><span>&copy; 2022
<a href=https://emilienm.github.io/></a>
| Powered by <a href=https://github.com/dsrkafuu/hugo-theme-fuji/ target=_blank>Fuji-v2</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></span></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.27.0/components/prism-core.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/prismjs@1.27.0/plugins/autoloader/prism-autoloader.min.js></script>
<script defer src=/assets/js/fuji.min.js></script></body></html>